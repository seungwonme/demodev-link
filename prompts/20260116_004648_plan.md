# Clerk → Supabase Auth 마이그레이션 계획

## 개요

- **목표**: Clerk 인증을 Supabase Auth로 완전 교체
- **마이그레이션 방식**: 클린 마이그레이션 (기존 사용자에게 비밀번호 재설정 이메일 발송)
- **인증 방식**: 이메일/비밀번호 + OAuth (Google, GitHub)
- **예상 소요 시간**: 12-19시간

## 영향 범위

| 영역         | 파일 수 | 영향도               |
| ------------ | ------- | -------------------- |
| 미들웨어     | 1       | 전체 재작성          |
| 인증 서비스  | 2       | 전체 재작성          |
| UI 컴포넌트  | 8       | 신규 생성/수정       |
| 데이터베이스 | 2       | 마이그레이션         |
| Webhook      | 1       | 삭제 (트리거로 대체) |

---

## Phase 1: 데이터베이스 스키마 마이그레이션

### 목표
`profiles.id`를 TEXT에서 UUID로 변경하고 status/role 컬럼 추가

### 생성할 파일
- `supabase/migrations/YYYYMMDD_migrate_to_supabase_auth.sql`

### 주요 변경사항
```sql
-- profiles 테이블 재구성
CREATE TABLE profiles_new (
    id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
    email TEXT,
    status TEXT DEFAULT 'pending' CHECK (status IN ('pending', 'approved', 'rejected')),
    role TEXT DEFAULT 'user' CHECK (role IN ('user', 'admin')),
    approved_at TIMESTAMPTZ,
    approved_by UUID,
    rejected_at TIMESTAMPTZ,
    rejected_by UUID,
    rejection_reason TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- 자동 프로필 생성 트리거
CREATE TRIGGER on_auth_user_created
    AFTER INSERT ON auth.users
    FOR EACH ROW
    EXECUTE FUNCTION public.handle_new_user();
```

### RLS 정책 (auth.uid() 사용)
```sql
CREATE POLICY "Users can view own profile" ON profiles
    FOR SELECT USING (id = auth.uid());

CREATE POLICY "Admins can view all profiles" ON profiles
    FOR SELECT USING (is_admin());
```

---

## Phase 2: 인증 서비스 마이그레이션

### 목표
`ClerkAuthService`를 `SupabaseAuthService`로 대체

### 생성할 파일
- `src/features/auth/services/supabase-auth.service.ts`
- `src/features/auth/actions/supabase-user.ts`

### API 호환성 유지
| 메서드                                     | 설명                                 |
| ------------------------------------------ | ------------------------------------ |
| `getCurrentUser()`                         | Supabase auth + profiles 테이블 조회 |
| `requireAuth(options)`                     | 인증/상태/역할 검증 후 리다이렉트    |
| `isAdmin()`                                | admin 역할 확인                      |
| `isApproved()`                             | approved 상태 확인                   |
| `getUsersByStatus(status)`                 | 상태별 사용자 목록 (admin only)      |
| `updateUserStatus(userId, status, reason)` | 상태 업데이트 (admin only)           |
| `updateUserRole(userId, role)`             | 역할 업데이트 (admin only)           |

---

## Phase 3: 미들웨어 마이그레이션

### 목표
Clerk 미들웨어를 Supabase SSR 미들웨어로 교체

### 수정할 파일
- `src/middleware.ts` (전체 재작성)

### 핵심 변경
```typescript
// Before (Clerk)
import { clerkMiddleware } from '@clerk/nextjs/server';
const { userId, sessionClaims } = await auth();

// After (Supabase)
import { createServerClient } from "@supabase/ssr";
const { data: { user } } = await supabase.auth.getUser();
const { data: profile } = await supabase.from("profiles").select("status, role");
```

---

## Phase 4: UI 컴포넌트

### 생성할 파일
| 파일                                               | 용도                           |
| -------------------------------------------------- | ------------------------------ |
| `src/features/auth/providers/auth-provider.tsx`    | 인증 컨텍스트 Provider         |
| `src/features/auth/components/sign-in-form.tsx`    | 로그인 폼 (이메일 + OAuth)     |
| `src/features/auth/components/sign-up-form.tsx`    | 회원가입 폼 (이메일 확인 포함) |
| `src/features/auth/components/user-menu.tsx`       | 사용자 드롭다운 메뉴           |
| `src/features/auth/components/sign-out-button.tsx` | 로그아웃 버튼                  |

### 수정할 파일
| 파일                                                   | 변경 내용                                        |
| ------------------------------------------------------ | ------------------------------------------------ |
| `src/app/layout.tsx`                                   | `ClerkProvider` → `AuthProvider`                 |
| `src/app/admin/login/[[...sign-in]]/page.tsx`          | `SignIn` → `SignInForm`                          |
| `src/app/admin/register/[[...sign-up]]/page.tsx`       | `SignUp` → `SignUpForm`                          |
| `src/shared/components/nav.tsx`                        | `useUser` → `useAuth`, `UserButton` → `UserMenu` |
| `src/features/auth/components/admin/sidebar.tsx`       | `UserButton` → `UserMenu`                        |
| `src/features/links/components/url/url-input-form.tsx` | `useUser` → `useAuth`                            |
| `src/app/admin/pending/page.tsx`                       | Clerk `SignOutButton` → 커스텀                   |
| `src/app/admin/rejected/page.tsx`                      | Clerk `SignOutButton` → 커스텀                   |

### Supabase 클라이언트 업데이트
- `src/lib/supabase/server.ts` - Clerk JWT 제거, 쿠키 기반 인증
- `src/lib/supabase/client.ts` - 단순화

---

## Phase 5: OAuth 설정

### Supabase 대시보드 설정
1. **Google OAuth**: Authentication → Providers → Google
2. **GitHub OAuth**: Authentication → Providers → GitHub
3. **Redirect URLs**: `http://localhost:3000/auth/callback`, `https://도메인/auth/callback`

### 생성할 파일
| 파일                                    | 용도             |
| --------------------------------------- | ---------------- |
| `src/app/auth/callback/route.ts`        | OAuth 콜백 처리  |
| `src/app/auth/confirm/route.ts`         | 이메일 확인 처리 |
| `src/app/auth/auth-code-error/page.tsx` | 인증 오류 페이지 |

---

## Phase 6: 사용자 마이그레이션

### 생성할 파일
- `scripts/migrate-clerk-to-supabase.ts`

### 마이그레이션 프로세스
1. Clerk에서 모든 사용자 조회
2. Supabase Auth에 사용자 생성 (이메일 확인됨으로 설정)
3. Clerk metadata → profiles 테이블로 이전
4. 비밀번호 재설정 이메일 발송
5. 매핑 테이블에 기록

### package.json 스크립트 추가
```json
"migrate:clerk-to-supabase": "tsx scripts/migrate-clerk-to-supabase.ts"
```

---

## Phase 7: 정리

### 삭제할 파일
- `src/features/auth/services/clerk-auth.service.ts`
- `src/features/auth/actions/clerk-user.ts`
- `src/app/api/webhooks/clerk/route.ts`
- `scripts/migrate-users-to-clerk.ts`

### 제거할 패키지
```bash
pnpm remove @clerk/nextjs @clerk/localizations @clerk/backend svix
```

### 제거할 환경변수
```
NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY
CLERK_SECRET_KEY
CLERK_WEBHOOK_SECRET
```

### 마이그레이션 완료 후 SQL
```sql
DROP TABLE IF EXISTS clerk_to_supabase_mapping;
```

---

## 테스트 전략

### 단위 테스트
- [ ] `SupabaseAuthService` 각 메서드
- [ ] 폼 유효성 검사

### 통합 테스트
- [ ] 회원가입 플로우 (이메일 + OAuth)
- [ ] 로그인 플로우
- [ ] 미들웨어 리다이렉트
- [ ] RLS 정책

### E2E 테스트
- [ ] 회원가입 → 대기 → 승인 플로우
- [ ] 관리자 사용자 관리
- [ ] 보호된 라우트 접근

---

## 롤백 계획

1. Clerk 환경변수 2주간 유지
2. `clerk_to_supabase_mapping` 테이블 보관
3. 문제 발생 시:
   - Clerk 환경변수 복원
   - Clerk 미들웨어/Provider 복원
   - 사용자들은 기존 Clerk 자격증명 사용 가능

---

## 구현 순서

| 순서 | Phase               | 예상 시간 |
| ---- | ------------------- | --------- |
| 1    | 데이터베이스 스키마 | 2-3시간   |
| 2    | 인증 서비스         | 2-3시간   |
| 3    | 미들웨어            | 1-2시간   |
| 4    | UI 컴포넌트         | 3-4시간   |
| 5    | OAuth 설정          | 1-2시간   |
| 6    | 사용자 마이그레이션 | 2-3시간   |
| 7    | 정리                | 1-2시간   |

---

## 핵심 파일 목록

### 수정 필요
- `src/middleware.ts`
- `src/lib/supabase/server.ts`
- `src/lib/supabase/client.ts`
- `src/app/layout.tsx`
- `src/app/admin/login/[[...sign-in]]/page.tsx`
- `src/app/admin/register/[[...sign-up]]/page.tsx`
- `src/app/admin/pending/page.tsx`
- `src/app/admin/rejected/page.tsx`
- `src/shared/components/nav.tsx`
- `src/features/auth/components/admin/sidebar.tsx`
- `src/features/links/components/url/url-input-form.tsx`

### 신규 생성
- `supabase/migrations/YYYYMMDD_migrate_to_supabase_auth.sql`
- `src/features/auth/services/supabase-auth.service.ts`
- `src/features/auth/actions/supabase-user.ts`
- `src/features/auth/providers/auth-provider.tsx`
- `src/features/auth/components/sign-in-form.tsx`
- `src/features/auth/components/sign-up-form.tsx`
- `src/features/auth/components/user-menu.tsx`
- `src/features/auth/components/sign-out-button.tsx`
- `src/app/auth/callback/route.ts`
- `src/app/auth/confirm/route.ts`
- `src/app/auth/auth-code-error/page.tsx`
- `scripts/migrate-clerk-to-supabase.ts`

### 삭제 예정
- `src/features/auth/services/clerk-auth.service.ts`
- `src/features/auth/actions/clerk-user.ts`
- `src/app/api/webhooks/clerk/route.ts`
