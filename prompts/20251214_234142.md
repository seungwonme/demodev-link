seungwonan

이제 이거 할래

## Vercel Cron으로 Supabase 활성 상태 유지

Supabase 무료 플랜은 7일 동안 활동이 없으면 프로젝트가 일시 중지됩니다. Vercel Cron을 사용하여 6일마다 요청을 보내 이를 방지할 수 있습니다.

### Step 1: API Route 생성

```typescript
// src/app/api/cron/keep-alive/route.ts
import { createClient } from "@supabase/supabase-js";
import { NextResponse } from "next/server";

// Service Role Key 사용 (인증 없이 실행)
function createAdminClient() {
  return createClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.SUPABASE_SERVICE_ROLE_KEY!,
    {
      auth: {
        autoRefreshToken: false,
        persistSession: false,
      },
    }
  );
}

export async function GET(request: Request) {
  // Vercel Cron 인증 확인 (선택사항이지만 권장)
  const authHeader = request.headers.get("authorization");
  if (authHeader !== `Bearer ${process.env.CRON_SECRET}`) {
    return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
  }

  try {
    const supabase = createAdminClient();

    // 간단한 쿼리로 DB 활성화 (profiles 테이블 count)
    const { count, error } = await supabase
      .from("profiles")
      .select("*", { count: "exact", head: true });

    if (error) {
      console.error("Keep-alive query failed:", error);
      return NextResponse.json(
        { error: "Database query failed" },
        { status: 500 }
      );
    }

    console.log(`Keep-alive: ${count} profiles found at ${new Date().toISOString()}`);

    return NextResponse.json({
      success: true,
      message: "Supabase keep-alive ping successful",
      timestamp: new Date().toISOString(),
    });
  } catch (error) {
    console.error("Keep-alive error:", error);
    return NextResponse.json(
      { error: "Internal server error" },
      { status: 500 }
    );
  }
}
```

### Step 2: vercel.json 설정

```json
{
  "crons": [
    {
      "path": "/api/cron/keep-alive",
      "schedule": "0 0 */6 * *"
    }
  ]
}
```

**Cron 표현식 설명**:
- `0 0 */6 * *` = 매 6일마다 00:00 UTC에 실행
- 형식: `분 시 일 월 요일`

**다른 스케줄 옵션**:
| 표현식 | 설명 |
|--------|------|
| `0 0 */6 * *` | 6일마다 (권장) |
| `0 0 * * 0` | 매주 일요일 |
| `0 0 1,15 * *` | 매월 1일, 15일 |

### Step 3: 환경 변수 추가

```bash
# .env.local
CRON_SECRET=your-random-secret-string

# 생성 방법
openssl rand -base64 32
```

Vercel Dashboard → Settings → Environment Variables에서 `CRON_SECRET` 추가.

### Step 4: Vercel에서 Cron 활성화

1. `vercel.json`을 프로젝트 루트에 배치
2. Vercel에 배포
3. Vercel Dashboard → Settings → Crons에서 확인

**참고**: Vercel Hobby 플랜은 하루 1회 Cron 실행 제한이 있습니다. Pro 플랜부터 무제한입니다.

### 인증 없이 간단하게 사용 (비권장)

보안이 덜 중요한 경우 인증 없이 간단하게 구현할 수 있습니다:

```typescript
// src/app/api/cron/keep-alive/route.ts
import { createClient } from "@supabase/supabase-js";
import { NextResponse } from "next/server";

export async function GET() {
  const supabase = createClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.SUPABASE_SERVICE_ROLE_KEY!
  );

  const { error } = await supabase
    .from("profiles")
    .select("id", { count: "exact", head: true });

  if (error) {
    return NextResponse.json({ error: error.message }, { status: 500 });
  }

  return NextResponse.json({ ok: true, timestamp: new Date().toISOString() });
}
```

### 로컬 테스트

```bash
# 환경 변수 설정 후 테스트
curl -H "Authorization: Bearer $CRON_SECRET" http://localhost:3000/api/cron/keep-alive
```

### Vercel Cron 로그 확인

Vercel Dashboard → Logs에서 Cron 실행 로그 확인 가능.

---
